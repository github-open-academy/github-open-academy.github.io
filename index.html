<!DOCTYPE html>
<html>

<head>
  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <title>Open Academy</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.2.1/css/bootstrap.min.css" integrity="sha384-GJzZqFGwb1QTTN6wy59ffF1BuGJpLSa9DkKMp0DgiMDm4iYMj70gZWKYbI706tWS"
    crossorigin="anonymous">
  <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.6.3/css/all.css" integrity="sha384-UHRtZLI+pbxtHCWp1t77Bi1L4ZtiqrqD80Kn4Z8NTSRyMA2Fd33n5dQ8lWUE00s/"
    crossorigin="anonymous">
  <style>

    .trip-search-form {
      padding-bottom: 40px;
    }

  </style>
</head>

<body>
  <header>
    <div class="navbar navbar-dark bg-dark shadow-sm">
      <div class="container d-flex justify-content-between">
        <a href="#" class="navbar-brand d-flex align-items-center">
          <i class="fa fa-graduation-cap" aria-hidden="true"></i>
          <strong>Odemy</strong>
        </a>
      </div>
    </div>
  </header>
  <main role="main">
    <div id="app"></div>
  </main>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <script src="https://unpkg.com/axios/dist/axios.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.23.0/moment.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/Director/1.2.8/director.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/markdown-it/8.4.2/markdown-it.min.js"></script>
  <script type="module">
    import preact from 'https://cdn.jsdelivr.net/npm/preact/dist/preact.mjs';
    
    window.preact = preact;
  </script>

  <!-- Courses -->
  <script defer type="text/babel">
    /** @jsx h */
    const { h, render, Component } = preact;

    class Courses extends Component {

      constructor(props) {
        super(props);
        this.setState({
          courses: []
        })
        axios.get('https://api.github.com/repos/github-open-academy/fork-me/forks?sort=stargazers&access_token=273852bce6f03812c0a064ab8cef00bace2b1814')
        .then((response) => {
          console.log(response)
          this.setState({
            courses: response.data
          });
        }).catch(function(ex) {
          console.log('parsing failed', ex)
        })
      }
    
      render(props, state){
        const renderCourses = this.state.courses.map(
          course => (
              <Card course={course}/>
            )
          );
        return (
          //<div class="card-group">
            <div class="row">
              {renderCourses}
            </div>
          //</div>
        );
      }
    }

  </script>

  <!-- Card -->
  <script defer type="text/babel">
    /** @jsx h */
    const { h, render, Component } = preact;

    function ago(date){
      return moment(date).fromNow();
    }

    function toTitle(string) {
      const dashToSpaceString = string.replace(/-/g, ' ');
      return dashToSpaceString.charAt(0).toUpperCase() + dashToSpaceString.slice(1);
    }

    const Card = (props) => (
      <div class="col-lg-3 col-sm-4 pb-4 pl-2 pr-2">
        <div class="card">
          <img src={`https://placeimg.com/400/200?t=${Math.random()}`} class="card-img-top" style="max-width: 407px" alt="..." />
          <div class="card-body">
            <h6 class="card-title">{toTitle(props.course.name)}</h6>
            <div class="row">
              <div class="col">
                <small><i class="far fa-user"></i> {props.course.owner.login}</small>
              </div>
              <div class="col">
                <p class="text-right"><small class="badge badge-warning"><i class="far fa-star"></i> {props.course.stargazers_count}</small></p>
              </div>
            </div>
            <p><small class="card-text text-justify">{props.course.description}</small></p>
            <a href={`#/${props.course.owner.login}/${props.course.name}`} class="btn btn-block btn-primary" aria-pressed="true">Watch</a>
          </div>
          <div class="card-footer">
              <small class="text-muted">Updated {ago(props.course.updated_at)}</small>
          </div>
        </div>
      </div>
    )

  </script>
  <!-- Search -->
  <script defer type="text/babel">
    /** @jsx h */
    const { h, render } = preact;
    
    const Search = ({children, ...props}) => (
      <form class="trip-search-form">
        <div class="row justify-content-md-center">
          <div class="col-lg-7 col-md-7 col-sm-12 mt-3">
            <div class="input-group input-group-lg">
              <input type="text" class="form-control" name="filter" placeholder="Topic" aria-label="Topic"
                aria-describedby="basic-addon2" />
              <div class="input-group-append">
                <button class="btn btn-primary" type="submit"><i class="fas fa-search-location"></i></button>
              </div>
            </div>
          </div>
        </div>
      </form>
    )
  </script>

  <!-- Template -->
  <script defer type="text/babel">
    /** @jsx h */
    const { h, render } = preact;
    
    const Template = ({children, ...props}) => (
      <div>
          
        <div class="container">
          { children }
        </div>
    </div>
    )
  </script>

  <!-- Playlist -->
  <script defer type="text/babel">
    /** @jsx h */
    const { h, render } = preact;
    
    const Playlist = ({children, ...props}) => {
      const renderPlaylist = props.playlist.map(p => {
        return (
          <li  className={`list-group-item ${p.ytId === decodeURIComponent(props.details.content) ? 'list-group-item-primary' : ''}`}><a href={`#/${props.details.user}/${props.details.name}/${p.ytId}`}>{p.title}</a></li>
        )
      })
      console.log('Playlist')
      return (
      <ul class="list-group">
        <li class="list-group-item"><a href="/#">Back</a></li>
        <li class="list-group-item"><a href={`#/${props.details.user}/${props.details.name}`}>About</a></li>
        {renderPlaylist}
      </ul>
    )}
  </script>

  <!-- Content -->
  <script defer type="text/babel">
    /** @jsx h */
    const { h, render } = preact;
    
    const Content = ({children, ...props}) => {

      let contentComponent = (
        <div class="embed-responsive embed-responsive-16by9">
          <iframe class="embed-responsive-item"  src={`https://www.youtube.com/embed/${props.value}`} frameborder="0" allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture" allowfullscreen></iframe>
        </div>
      )
      if (props.type === 'md') {
        contentComponent = (
          <div dangerouslySetInnerHTML={{__html: props.value}}>
          </div>
        )
      }
        
      return contentComponent;
    }
  </script>

  <!-- Course Page -->
  <script defer type="text/babel">
    /** @jsx h */
    const { h, render, Component } = preact;

    class CoursePage extends Component {

      constructor(props){
        super();

        let readmeResponse = '### Needs update...';
        let playlist: [];

        this.setState({
          readmeResponse,
          playlist: []
        })

        this.props = props;

        console.log(props.content);
        
        axios.get(`https://raw.githubusercontent.com/${props.user}/${props.name}/master/README.md`)
        .then((response) => {
          
          readmeResponse = markdownit().render(response.data)
          
        }).catch(function(ex) {
          console.log('parsing failed', ex)
        }).then(()=>{
          axios.get(`https://raw.githubusercontent.com/${props.user}/${props.name}/master/playlist.json`)
          .then((response) => {
            console.log('pl', response)
            this.setState({
              playlist: response.data,
              readmeResponse
            });
          }).catch(function(ex) {
            console.log('parsing failed', ex)
          });

        })
      }

      render() {
        const contentType = typeof(this.props.content) === 'undefined' ? 'md' : 'video';
        const value = contentType === 'md' ? this.state.readmeResponse : this.props.content;
        return (
        
        <div class="row mt-3">
          <div class="col-lg-4 col-sm-12">
            <Playlist details={this.props} playlist={this.state.playlist}/>
          </div>
          <div class="col-lg-8 col-sm-12">
            <Content type={contentType} value={value} />
          </div>
        </div>
        )
      }
    }
  </script>


  <!-- App -->
  <script defer type="text/babel">
    /** @jsx h */
    const { h, render, Component } = preact;

    class App extends Component {

      constructor(props){
        super();

        this.setState({
          component: <div><Search /> <Courses /></div>
        })
        
        const routes = {
          '/:user/:name': (user, name)=>{
            console.log(user, name);
            this.setState({
              component: <CoursePage user={user} name={name}/>
            })
          },

          '/:user/:name/:content': (user, name, content)=>{
            this.setState({
              component: <CoursePage user={user} name={name} content={content}/>
            })
          },


          '/': (...ctx)=>{
            console.log(ctx);
            this.setState({
              component: <div><Search /> <Courses /></div>
            })
          },


        }

        const router = Router(routes);

        router.init();
      }

      render({children, ...props}){
        return (<Template>{this.state.component}</Template>)
      }
    }
  
    render(<App />, document.getElementById('app'))
    
    
  </script>
</body>

</html>